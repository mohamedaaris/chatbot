{% extends "layout.html" %}

{% block title %}Generate Embed Code - AgentX Platform{% endblock %}

{% block extra_css %}
    .embed-form {
      max-width: 600px;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .form-group select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-secondary);
      color: var(--text);
      font-size: 15px;
      transition: all 0.2s;
    }

    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 32px;
    }

    .embed-preview {
      margin-top: 32px;
      padding: 24px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      display: none;
    }

    .embed-preview h3 {
      margin-bottom: 16px;
      color: var(--text);
    }

    .code-block {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
      position: relative;
    }

    .code-block pre {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      overflow-x: auto;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      color: var(--text);
      margin: 0;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .code-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .code-actions .btn {
      padding: 8px 16px;
      font-size: 13px;
    }

    .theme-preview {
      margin-top: 16px;
      padding: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    .theme-preview h4 {
      margin-bottom: 12px;
      color: var(--text);
      font-size: 14px;
    }

    .theme-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      cursor: pointer;
    }

    .theme-option input[type="radio"] {
      margin: 0;
    }

    .theme-option label {
      cursor: pointer;
      color: var(--text);
      font-size: 14px;
    }

    .theme-preview-widget {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-secondary);
      font-size: 12px;
      color: var(--text-secondary);
    }

    .success-message {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid var(--success);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 24px;
      color: var(--success);
    }

    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--error);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 24px;
      color: var(--error);
    }

    .embed-instructions {
      margin-top: 24px;
      padding: 20px;
      background: var(--bg-tertiary);
      border-radius: var(--radius);
      border-left: 4px solid var(--accent);
    }

    .embed-instructions h4 {
      margin-bottom: 12px;
      color: var(--text);
      font-size: 16px;
    }

    .embed-instructions ol {
      margin: 0;
      padding-left: 20px;
    }

    .embed-instructions li {
      padding: 4px 0;
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.5;
    }

    .copy-success {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 12px 20px;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 600;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
{% endblock %}

{% block content %}
<div class="page-container">
  <div class="page-header">
    <div>
      <h1 class="page-title">Generate Embed Code</h1>
      <p class="page-subtitle">Create embeddable widgets for your agents</p>
    </div>
  </div>
  
  <div class="page-content">
    <div id="messageContainer"></div>
    
    <form id="embedCodeForm" class="embed-form">
      <div class="form-group">
        <label for="embedAgentSelect">Select Agent</label>
        <select id="embedAgentSelect" name="agentId" required>
          <option value="">Choose an agent to embed...</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="embedTheme">Widget Theme</label>
        <select id="embedTheme" name="theme">
          <option value="dark">Dark Theme</option>
          <option value="light">Light Theme</option>
          <option value="auto">Auto (Follows site theme)</option>
        </select>
      </div>
      
      <div class="form-actions">
        <a href="/my-agents" class="btn btn-secondary">Cancel</a>
        <button type="submit" class="btn btn-primary">Generate Code</button>
      </div>
    </form>

    <div class="embed-preview" id="embedPreview">
      <h3>Generated Embed Code</h3>
      <div class="code-block">
        <pre id="embedCode"></pre>
      </div>
      <div class="code-actions">
        <button class="btn btn-primary" onclick="copyEmbedCode()">Copy Code</button>
        <button class="btn btn-secondary" onclick="downloadCode()">Download</button>
      </div>
    </div>

    <div class="embed-instructions">
      <h4>How to Use This Embed Code</h4>
      <ol>
        <li>Copy the generated code above</li>
        <li>Paste it into your website's HTML where you want the chat widget to appear</li>
        <li>The widget will automatically load and connect to your agent</li>
        <li>Users can click the chat icon to start a conversation</li>
        <li>The widget will remember conversations during the session</li>
        <li>You can customize the appearance by modifying the CSS in the code</li>
      </ol>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
    document.addEventListener('DOMContentLoaded', function() {
      loadAgents();
      setupFormHandlers();
      setupThemePreview();
    });

    async function loadAgents() {
      try {
        const response = await fetch('/agents');
        const data = await response.json();
        
        const select = document.getElementById('embedAgentSelect');
        select.innerHTML = '<option value="">Choose an agent to embed...</option>';
        
        if (data.success && data.agents) {
          data.agents.forEach(agent => {
            const option = document.createElement('option');
            option.value = agent.id;
            option.textContent = agent.name;
            select.appendChild(option);
          });
        }

        // Check for agent parameter in URL
        const urlParams = new URLSearchParams(window.location.search);
        const agentId = urlParams.get('agent');
        if (agentId) {
          select.value = agentId;
        }
      } catch (error) {
        console.error('Error loading agents:', error);
      }
    }

    function setupFormHandlers() {
      const form = document.getElementById('embedCodeForm');
      
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(form);
        const agentId = formData.get('agentId');
        const theme = formData.get('theme');

        if (!agentId) {
          showMessage('Please select an agent.', 'error');
          return;
        }

        try {
          showMessage('Generating embed code...', 'success');
          
          const response = await fetch('/embed_script', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ agent_id: agentId, theme: theme })
          });

          const result = await response.json();
          
          if (result.success) {
            document.getElementById('embedCode').textContent = result.script;
            document.getElementById('embedPreview').style.display = 'block';
            showMessage('Embed code generated successfully!', 'success');
          } else {
            showMessage('Error generating embed code: ' + result.error, 'error');
          }
        } catch (error) {
          console.error('Error generating embed code:', error);
          showMessage('Error generating embed code: ' + error.message, 'error');
        }
      });
    }

    function setupThemePreview() {
      const themeSelect = document.getElementById('embedTheme');
      
      themeSelect.addEventListener('change', (e) => {
        updateThemePreview(e.target.value);
      });
    }

    function updateThemePreview(theme) {
      // This would update a preview widget if we had one
      console.log('Theme changed to:', theme);
    }

    function copyEmbedCode() {
      const code = document.getElementById('embedCode').textContent;
      
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(code).then(() => {
          showCopySuccess();
        }).catch(err => {
          console.error('Failed to copy: ', err);
          fallbackCopyTextToClipboard(code);
        });
      } else {
        fallbackCopyTextToClipboard(code);
      }
    }

    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.top = "0";
      textArea.style.left = "0";
      textArea.style.position = "fixed";
      
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showCopySuccess();
        } else {
          showMessage('Failed to copy code. Please select and copy manually.', 'error');
        }
      } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
        showMessage('Failed to copy code. Please select and copy manually.', 'error');
      }
      
      document.body.removeChild(textArea);
    }

    function showCopySuccess() {
      const successDiv = document.createElement('div');
      successDiv.className = 'copy-success';
      successDiv.textContent = 'Code copied to clipboard!';
      
      document.body.appendChild(successDiv);
      
      setTimeout(() => {
        document.body.removeChild(successDiv);
      }, 3000);
    }

    function downloadCode() {
      const code = document.getElementById('embedCode').textContent;
      const agentSelect = document.getElementById('embedAgentSelect');
      const selectedOption = agentSelect.options[agentSelect.selectedIndex];
      const agentName = selectedOption ? selectedOption.textContent : 'agent';
      
      const blob = new Blob([code], { type: 'text/html' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${agentName}-embed-code.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function showMessage(message, type) {
      const container = document.getElementById('messageContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `${type}-message`;
      messageDiv.textContent = message;
      
      // Clear existing messages
      container.innerHTML = '';
      container.appendChild(messageDiv);
      
      // Auto-hide success messages
      if (type === 'success') {
        setTimeout(() => {
          messageDiv.remove();
        }, 5000);
      }
    }
{% endblock %}
